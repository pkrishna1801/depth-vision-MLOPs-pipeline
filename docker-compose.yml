version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: ${TARGET:-development}  # Default to development, can override with TARGET=production
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - CHOKIDAR_USEPOLLING=true
      - HOST=0.0.0.0
      - PORT=3000
      - REACT_APP_YOLO_API=http://localhost:5000
      - REACT_APP_DEPTH_API=http://localhost:5050
    volumes:
      # Mount source code for live reloading in development
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      # Exclude node_modules to avoid conflicts
      - /app/node_modules
    networks:
      - mlops-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      yolo-backend:
        condition: service_healthy
      depth-backend:
        condition: service_healthy

  yolo-backend:
    build:
      context: ./yolo-backend
      dockerfile: Dockerfile
      target: ${TARGET:-development}  # Default to development, can override with TARGET=production
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=${FLASK_ENV:-development}
      - PYTHONUNBUFFERED=1
    volumes:
      # Mount source code for live reloading in development
      - ./yolo-backend:/app
      # Persistent cache for model downloads
      - yolo_models:/root/.cache/torch
      # Exclude yolov5 directory to avoid conflicts
      - /app/yolov5
    networks:
      - mlops-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s  # Give more time for model loading

  depth-backend:
    build:
      context: ./depth-backend
      dockerfile: Dockerfile
      target: ${TARGET:-development}  # Default to development, can override with TARGET=production
    ports:
      - "5050:5050"
    environment:
      - FLASK_ENV=${FLASK_ENV:-development}
      - PYTHONUNBUFFERED=1
    volumes:
      # Mount source code for live reloading in development
      - ./depth-backend:/app
      # Persistent cache for model downloads
      - depth_models:/root/.cache/torch
      - depth_hf_models:/root/.cache/huggingface
      # Exclude depth_anything_v2 directory to avoid conflicts (fixed name)
      - /app/depth_anything_v2
      - /app/checkpoints
    networks:
      - mlops-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/health"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 150s  # Give more time for model loading (depth models are larger)

networks:
  mlops-network:
    driver: bridge

volumes:
  yolo_models:
    driver: local
  depth_models:
    driver: local
  depth_hf_models:
    driver: local